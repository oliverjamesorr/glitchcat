<!DOCTYPE html>
<html>

<head>
    <title>3D Platformer</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            color: white;
            font-family: sans-serif;
        }

        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px;
            border-radius: 5px;
        }

        #menu,
        #levelSelector {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            display: none;
        }

        #levelSelector button {
            margin: 4px;
            padding: 6px 12px;
        }
    </style>
</head>

<body>
    <div id="ui">Level 1 - WASD + Mouse. Space: Jump | G: Gravity | D: Double Jump | T: Time Slow | F: Dash | Click:
        Swing Bat<br>❤️ <span id="hearts">3</span> Lives</div>
    <div id="menu">
        <button onclick="startGame()">Start Game</button>
        <button onclick="loadGame()">Load Game</button>
    </div>
    <div id="levelSelector"></div>
    <audio id="hitSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_d229b2bb27.mp3"></audio>
    <audio id="winSound" src="https://cdn.pixabay.com/audio/2022/03/02/audio_d79e5306c3.mp3"></audio>
    <audio id="bgMusic" src="https://cdn.pixabay.com/audio/2022/03/16/audio_5df7b2f1f6.mp3" loop autoplay></audio>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.158.0/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/PointerLockControls.js"></script>
    <script>
        let scene, camera, renderer, controls, player, velocity, onGround = false;
        let powerups = { gravity: false, doubleJump: false, dash: true, timeSlow: false };
        let canDoubleJump = false, speed = 400;
        let boss, bossHealth = 3;
        let enemies = [], particles = [], fireballs = [];
        const hitSound = document.getElementById("hitSound");
        const winSound = document.getElementById("winSound");
        let currentLevel = 1;
        let maxLevel = 1;
        let shakeTime = 0;
        let health = 3;

        const ui = document.getElementById("ui");
        const hearts = document.getElementById("hearts");
        const menu = document.getElementById("menu");
        const levelSelector = document.getElementById("levelSelector");

        function saveGame() {
            localStorage.setItem("platformerSave", JSON.stringify({ level: maxLevel, health }));
        }
        function loadGame() {
            const save = JSON.parse(localStorage.getItem("platformerSave"));
            if (save) {
                maxLevel = save.level || 1;
                health = save.health || 3;
                updateHearts();
                showLevelSelector();
            }
        }
        function startGame() {
            menu.style.display = "none";
            levelSelector.style.display = "none";
            currentLevel = 1;
            health = 3;
            maxLevel = 1;
            init();
            animate();
        }
        function showLevelSelector() {
            levelSelector.innerHTML = '<h2>Select Level</h2>';
            for (let i = 1; i <= maxLevel; i++) {
                const btn = document.createElement("button");
                btn.textContent = `Level ${i}`;
                btn.onclick = () => {
                    currentLevel = i;
                    levelSelector.style.display = "none";
                    clearScene();
                    addLevel(currentLevel);
                    player.position.set(0, 20, 0);
                };
                levelSelector.appendChild(btn);
            }
            levelSelector.style.display = "block";
        }
        function updateHearts() {
            hearts.textContent = health;
            if (health <= 0) {
                alert("Game Over");
                health = 3;
                currentLevel = 1;
                maxLevel = 1;
                saveGame();
            }
        }

        menu.style.display = "block";
        // GAMEPLAY LOGIC CONTINUES FROM CHUNK 1
        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 10000);
            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            controls = new THREE.PointerLockControls(camera, document.body);
            scene.add(controls.getObject());
            document.body.addEventListener('click', () => controls.lock());
            document.addEventListener('mousedown', () => swingBat());
            const light = new THREE.HemisphereLight(0xffffff, 0x444444);
            light.position.set(0, 200, 0);
            scene.add(light);
            addLevel(currentLevel);
            player = controls.getObject();
            velocity = new THREE.Vector3();
            document.addEventListener('keydown', onKeyDown);
        }

        function clearScene() {
            for (let i = scene.children.length - 1; i >= 0; i--) {
                const obj = scene.children[i];
                if (obj !== camera && obj !== controls.getObject()) {
                    scene.remove(obj);
                }
            }
            enemies = [];
            fireballs = [];
            boss = null;
            bossHealth = 3;
        }

        function nextLevel() {
            currentLevel++;
            if (currentLevel > maxLevel) {
                maxLevel = currentLevel;
                saveGame();
            }
            clearScene();
            addLevel(currentLevel);
            player.position.set(0, 20, 0);
        }

        function respawnPlayer() {
            health--;
            updateHearts();
            player.position.set(0, 20, 0);
            velocity.set(0, 0, 0);
            ui.innerText = `☠️ You took damage! Lives: ${health}`;
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = 0.016;
            velocity.y -= (powerups.gravity ? 2 : 9.8) * delta;
            player.position.y += velocity.y;
            if (player.position.y <= 0) {
                velocity.y = 0;
                player.position.y = 0;
                onGround = true;
                canDoubleJump = true;
            }
            if (player.position.y < -50) respawnPlayer();

            const portal = scene.getObjectByName("levelPortal");
            if (portal && player.position.distanceTo(portal.position) < 15) {
                nextLevel();
                ui.innerText = `➡️ Welcome to Level ${currentLevel}`;
            }

            enemies.forEach(e => {
                if (e.tick) e.tick(performance.now());
                if (player.position.distanceTo(e.position) < 10) respawnPlayer();
            });

            fireballs.forEach(f => {
                f.position.add(f.velocity);
                f.rotation.x += 0.1;
                f.rotation.y += 0.05;
                if (performance.now() - f.lastTrail > 100) {
                    const trail = new THREE.Mesh(new THREE.SphereGeometry(1, 4, 4), new THREE.MeshBasicMaterial({ color: 0xffaa00 }));
                    trail.position.copy(f.position);
                    scene.add(trail);
                    setTimeout(() => scene.remove(trail), 500);
                    f.lastTrail = performance.now();
                }
                if (f.position.x > 100 || f.position.x < -100) f.velocity.x *= -1;
                if (player.position.distanceTo(f.position) < 10) respawnPlayer();
            });

            particles.forEach((p, i) => {
                p.position.add(p.velocity.clone().multiplyScalar(delta));
                p.velocity.y -= 9.8 * delta;
                if (p.position.y < -5) {
                    scene.remove(p);
                    particles.splice(i, 1);
                }
            });

            if (shakeTime > 0) {
                camera.position.x += (Math.random() - 0.5) * 0.5;
                camera.position.y += (Math.random() - 0.5) * 0.5;
                shakeTime--;
            }

            renderer.render(scene, camera);
        }
    </script>
</body>

</html>